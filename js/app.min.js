"use strict";angular.module("video-ads",["ngCookies","ngRoute","ngAnimate","restangular","highcharts-ng"]).config(function($locationProvider,$httpProvider,$routeProvider,$sceDelegateProvider){$sceDelegateProvider.resourceUrlWhitelist(["self","http://assets.onionstatic.com/videoads/*","http://onionwebtech.s3.amazonaws.com/videoads/**"]),$locationProvider.html5Mode(!0),$routeProvider.when("/",{templateUrl:"components/videoAdList/videoAdList.html",controller:"VideoAdListController",reloadOnSearch:!1}).when("/login",{templateUrl:"components/login/login.html",controller:"LoginCtrl"}).when("/edit/:videoAdId/",{templateUrl:"components/detail/videoAdDetail.html",controller:"VideoAdDetailController"}).when("/new/",{templateUrl:"components/detail/videoAdDetail.html",controller:"VideoAdDetailController"}).when("/exclusion/:exclusionName/",{templateUrl:"components/exclusion/exclusion.html",controller:"ExclusionCtrl"}).otherwise({redirectTo:"/"})}),angular.module("video-ads").directive("pixels",function(){return{templateUrl:"components/detail/pixels.html",scope:{videoad:"=",pixels:"="},link:function($scope){$("#pixels-wrapper").on("keypress","input",function(e){return 13===e.keyCode?($(e.target).parent().find("button").click(),!1):void 0}),$scope.addPixel=function(e){var bt=$(e.target),event=$(bt).parents("[data-event]").data("event"),pixel=$(bt).parent().siblings("input").val();pixel.length>0&&($scope.videoad.pixels[event].push(pixel),$(bt).parent().siblings("input").val(""))},$scope.removePixel=function(event,index){$scope.videoad.pixels[event].splice(index,1)}}}}),angular.module("video-ads").directive("targeting",function(){return{templateUrl:"components/detail/targeting.html",scope:{target:"=",targets:"="},link:function($scope){$scope.priorities=["low","medium","high"],$scope.addTargetingGroup=function(){$scope.target.push({priority:"medium",rules:[["","is",""]]})},$scope.removeTargetingGroup=function(index,confirm){confirm?($scope.target.splice(index,1),$("#confirm-remove-group-modal").modal("hide")):($("#confirm-remove-group-modal-button").off("click"),$("#confirm-remove-group-modal-button").click(function(){$scope.removeTargetingGroup(index,!0),$scope.$apply()}),$("#confirm-remove-group-modal").modal("show"))},$scope.addTargetingRow=function(index){$scope.target[index].rules.push(["","is",""])},$scope.removeTargetingRow=function(parentIndex,index){$scope.target[parentIndex].rules.splice(index,1),0==$scope.target[parentIndex].rules.length&&$scope.target.splice(parentIndex,1)}}}}),angular.module("video-ads").directive("videoEditForm",function(){return{templateUrl:"components/detail/videoDetail.html",scope:{video:"=",adid:"=",index:"="}}}),angular.module("video-ads").service("Zencoder",function($http,$q){function uploadToS3(file,s3Config){var s3deferred=$q.defer(),formData=new FormData;return formData.append("key",s3Config.key),formData.append("AWSAccessKeyId",s3Config.AWSAccessKeyId),formData.append("acl",s3Config.acl),formData.append("success_action_status",s3Config.success_action_status),formData.append("policy",s3Config.policy),formData.append("signature",s3Config.signature),formData.append("file",file),$http.post(s3Config.upload_endpoint,formData,{ignoreAuthorizationHeader:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(){s3deferred.resolve(file)},function(response){s3deferred.reject(response)}),s3deferred.promise}function encode(videoObject){var encodeDeferred=$q.defer();return $http({method:"POST",url:"api/videos/"+videoObject.id+"/encode/"}).success(function(data){videoObject.attrs.encode_status_endpoints=data,encodeDeferred.resolve(videoObject)}).error(function(data){encodeDeferred.reject(data)}),encodeDeferred.promise}this.uploadToS3AndEncode=function(file,videoObject){uploadToS3(file,videoObject.encoding_payload).then(function(){encode(videoObject)})},this.encode=function(videoId){encode({attrs:{id:videoId}})}}),angular.module("video-ads").controller("VideoAdDetailController",["$scope","$routeParams","videoAdService","$location","$rootScope",function($scope,$routeParams,videoAdService,$location,$rootScope){$rootScope.showSaveButton=!0,$rootScope.showSearchBar=!1,$scope.success=!1,$scope.errors=!1,$scope.videoad={},$scope.page_targets=["dfp_adchannel","dfp_pagetype","dfp_viewport","dfp_channel","dfp_articletype","dfp_site","dfp_articleid"],$scope.user_targets=["city","region","country_code"],$scope.getAndInitVideoAd=function(){_.isUndefined($routeParams.videoAdId)?($scope.videoad={},$scope.videoad.id=null,$scope.initVideoAd()):videoAdService.one($routeParams.videoAdId).get().then(function(data){$scope.videoad=data,$scope.initVideoAd()},function(data){console.log(data)})},$scope.initVideoAd=function(){$scope.videoad.targeting||($scope.videoad.targeting={}),$scope.videoad.targeting.page||($scope.videoad.targeting.page=[]),$scope.videoad.targeting.user||($scope.videoad.targeting.user=[]),$scope.videoad.videos=$scope.videoad.videos||[]},$scope.addTargetingKey=function(key){$scope.targetingKey=key},$scope.saveVideoAd=function(){_.isUndefined($routeParams.videoAdId)?($(".alert-danger").fadeIn().delay(1e3).fadeOut(),videoAdService.post($scope.videoad).then(function(data){$location.path("/edit/"+data.id)})):($(".alert-success").fadeIn().delay(1e3).fadeOut(),$scope.videoad.save())},$scope.$on("save-video-ad",function(){$scope.saveVideoAd()}),$scope.addVideo=function(){$scope.videoad.videos.push({adId:$scope.videoad.id})},$scope.getAndInitVideoAd()}]),angular.module("video-ads").directive("videoField",function(Zencoder,$q,$http){return{templateUrl:"components/detail/videoField.html",transclude:!0,controller:function($scope){$scope.removeVideo=function(){$scope.video=null},$scope.uploadVideo=function(){var fileField=$("#"+$scope.index+"-file-field");fileField.unbind("change"),fileField.bind("change",function(event){var clickDeferred=$q.defer(),file=event.target.files[0];$scope.validateVideoFile(file).then(function(){$scope.addVideoToAdvertisement(file).then(function(){var videoObject=$scope.video;Zencoder.uploadToS3AndEncode($scope.file,videoObject)}).then(function(){clickDeferred.resolve()})})}),fileField.click()},$scope.validateVideoFile=function(file){var validateVideoFileDeferred=$q.defer();return file&&(file.size>1073741824?validateVideoFileDeferred.reject("Upload file cannot be larger than 1024MB."):0!==file.type.indexOf("video/")?validateVideoFileDeferred.reject("You must upload a video file."):validateVideoFileDeferred.resolve(),validateVideoFileDeferred.reject("Please select a file.")),validateVideoFileDeferred.promise},$scope.addVideoToAdvertisement=function(file){return $http.post("/api/videos/",{advertisement:$scope.adid,name:file.name}).then(function(response){$scope.video=response.data})}}}}),angular.module("video-ads").controller("ExclusionCtrl",function($scope,$http,$routeParams){$scope.exclusion={},$scope.page_targets=["dfp_adchannel","dfp_pagetype","dfp_viewport","dfp_channel","dfp_articletype","dfp_site","dfp_articleid"],$scope.user_targets=["city","region","country_code"],$http({method:"GET",url:"/api/v1/exclusions/"+$routeParams.exclusionName+"/"}).success(function(data){$scope.exclusion=data}),$scope.save=function(){var data=$scope.exclusion;$http({method:"PATCH",url:"/api/v1/exclusions/"+$routeParams.exclusionName+"/",data:data}).success(function(){$(".alert-success").fadeIn().delay(1e3).fadeOut()}).error(function(){$(".alert-danger").fadeIn().delay(1e3).fadeOut()})}}),angular.module("video-ads").controller("VideoAdListController",["$scope","$location","videoAdService","$routeParams","$rootScope",function($scope,$location,videoAdService,$routeParams,$rootScope){$scope.videoAds=[],$rootScope.showSearchBar=!0,$rootScope.showSaveButton=!1,$scope.params=_.isEmpty($location.search())?{page_size:8,filter:"active"}:$location.search(),$scope.currentPage=1,$scope.totalItems=0,$scope.loading=!0,$scope.errors=!1,$scope.updateList=function(){void 0===$scope.params.filter&&($scope.params.filter="active"),$location.search($scope.params),videoAdService.getList($scope.params).then(function(data){$scope.videoAds=data,$scope.totalItems=data.meta.count,$scope.loading=!1},function(error){$scope.loading=!1,$scope.errors=!0,console.log(error)},function(){$scope.loading=!0})},$scope.newVideoAd=function(){$location.path("/new/")},$scope.changeOrder=function(){$scope.params.orderBy=$scope.orderBy,$scope.reverse&&($scope.params.orderBy="-"+$scope.orderBy),$scope.currentPage=1,$scope.params.page=1,$scope.updateList()},$scope.changeFilter=function(){$scope.currentPage=1,$scope.params.page=1,$scope.updateList()},$scope.pageChanged=function(newPage){$scope.currentPage=newPage,$scope.params.page=$scope.currentPage,$scope.updateList()},$rootScope.$on("search",function(event,searchTerm){$scope.params.search=searchTerm,event.preventDefault(),$scope.updateList()}),$rootScope.$on("clearSearch",function(){$scope.params=_.omit($scope.params,"search"),$scope.updateList()}),$scope.updateList()}]),function(){var module,moduleName="video-ads",templatePath="components/videoAdList/dirPagination.tpl.html";try{module=angular.module(moduleName)}catch(err){module=angular.module(moduleName,[])}module.directive("dirPaginate",["$compile","$parse","$timeout","paginationService",function($compile,$parse,$timeout,paginationService){return{terminal:!0,multiElement:!0,priority:5e3,compile:function(tElement,tAttrs){tElement[0].hasAttribute("dir-paginate-start")||tElement[0].hasAttribute("data-dir-paginate-start")?(tAttrs.$set("ngRepeatStart",tAttrs.dirPaginate),tElement.eq(tElement.length-1).attr("ng-repeat-end",!0)):tAttrs.$set("ngRepeat",tAttrs.dirPaginate);var expression=tAttrs.dirPaginate,match=expression.match(/^\s*([\s\S]+?)\s+in\s+([\s\S]+?)(?:\s+track\s+by\s+([\s\S]+?))?\s*$/),filterPattern=/\|\s*itemsPerPage\s*:[^|]*/;if(null===match[2].match(filterPattern))throw"pagination directive: the 'itemsPerPage' filter must be set.";var itemsPerPageFilterRemoved=match[2].replace(filterPattern,""),collectionGetter=$parse(itemsPerPageFilterRemoved),paginationId=tAttrs.paginationId||"__default";return paginationService.registerInstance(paginationId),function(scope,element,attrs){var currentPageGetter,compiled=$compile(element,!1,5e3);if(attrs.currentPage)currentPageGetter=$parse(attrs.currentPage);else{var defaultCurrentPage=paginationId+"__currentPage";scope[defaultCurrentPage]=1,currentPageGetter=$parse(defaultCurrentPage)}paginationService.setCurrentPageParser(paginationId,currentPageGetter,scope),"undefined"!=typeof attrs.totalItems?(paginationService.setAsyncModeTrue(paginationId),scope.$watch(function(){return $parse(attrs.totalItems)(scope)},function(result){result>=0&&paginationService.setCollectionLength(paginationId,result)})):scope.$watchCollection(function(){return collectionGetter(scope)},function(collection){collection&&paginationService.setCollectionLength(paginationId,collection.length)}),compiled(scope)}}}}]),module.directive("dirPaginationControls",["paginationService",function(paginationService){function generatePagesArray(currentPage,collectionLength,rowsPerPage,paginationRange){var position,pages=[],totalPages=Math.ceil(collectionLength/rowsPerPage),halfWay=Math.ceil(paginationRange/2);position=halfWay>=currentPage?"start":currentPage>totalPages-halfWay?"end":"middle";for(var ellipsesNeeded=totalPages>paginationRange,i=1;totalPages>=i&&paginationRange>=i;){var pageNumber=calculatePageNumber(i,currentPage,paginationRange,totalPages),openingEllipsesNeeded=2===i&&("middle"===position||"end"===position),closingEllipsesNeeded=i===paginationRange-1&&("middle"===position||"start"===position);pages.push(ellipsesNeeded&&(openingEllipsesNeeded||closingEllipsesNeeded)?"...":pageNumber),i++}return pages}function calculatePageNumber(i,currentPage,paginationRange,totalPages){var halfWay=Math.ceil(paginationRange/2);return i===paginationRange?totalPages:1===i?i:totalPages>paginationRange?currentPage>totalPages-halfWay?totalPages-paginationRange+i:currentPage>halfWay?currentPage-halfWay+i:i:i}var numberRegex=/^\d+$/;return{restrict:"AE",templateUrl:function(elem,attrs){return attrs.templateUrl||templatePath},scope:{maxSize:"=?",onPageChange:"&?"},link:function(scope,element,attrs){function goToPage(num){isValidPageNumber(num)&&(scope.pages=generatePagesArray(num,paginationService.getCollectionLength(paginationId),paginationService.getItemsPerPage(paginationId),paginationRange),scope.pagination.current=num,scope.onPageChange&&scope.onPageChange({newPageNumber:num}))}function generatePagination(){var page=parseInt(paginationService.getCurrentPage(paginationId))||1;scope.pages=generatePagesArray(page,paginationService.getCollectionLength(paginationId),paginationService.getItemsPerPage(paginationId),paginationRange),scope.pagination.current=page,scope.pagination.last=scope.pages[scope.pages.length-1],scope.pagination.last<scope.pagination.current&&scope.setCurrent(scope.pagination.last)}function isValidPageNumber(num){return numberRegex.test(num)&&num>0&&num<=scope.pagination.last}var paginationId;if(paginationId=attrs.paginationId||"__default",scope.maxSize||(scope.maxSize=9),scope.directionLinks=angular.isDefined(attrs.directionLinks)?scope.$parent.$eval(attrs.directionLinks):!0,scope.boundaryLinks=angular.isDefined(attrs.boundaryLinks)?scope.$parent.$eval(attrs.boundaryLinks):!1,!paginationService.isRegistered(paginationId)){var idMessage="__default"!==paginationId?" (id: "+paginationId+") ":" ";throw"pagination directive: the pagination controls"+idMessage+"cannot be used without the corresponding pagination directive."}var paginationRange=Math.max(scope.maxSize,5);scope.pages=[],scope.pagination={last:1,current:1},scope.$watch(function(){return(paginationService.getCollectionLength(paginationId)+1)*paginationService.getItemsPerPage(paginationId)},function(length){length>0&&generatePagination()}),scope.$watch(function(){return paginationService.getCurrentPage(paginationId)},function(currentPage,previousPage){currentPage!=previousPage&&goToPage(currentPage)}),scope.setCurrent=function(num){isValidPageNumber(num)&&paginationService.setCurrentPage(paginationId,num)}}}}]),module.filter("itemsPerPage",["paginationService",function(paginationService){return function(collection,itemsPerPage,paginationId){if("undefined"==typeof paginationId&&(paginationId="__default"),!paginationService.isRegistered(paginationId))throw"pagination directive: the itemsPerPage id argument (id: "+paginationId+") does not match a registered pagination-id.";var end,start;return collection instanceof Array?(itemsPerPage=parseInt(itemsPerPage)||9999999999,start=paginationService.isAsyncMode(paginationId)?0:(paginationService.getCurrentPage(paginationId)-1)*itemsPerPage,end=start+itemsPerPage,paginationService.setItemsPerPage(paginationId,itemsPerPage),collection.slice(start,end)):collection}}]),module.service("paginationService",function(){var lastRegisteredInstance,instances={};this.registerInstance=function(instanceId){"undefined"==typeof instances[instanceId]&&(instances[instanceId]={asyncMode:!1},lastRegisteredInstance=instanceId)},this.isRegistered=function(instanceId){return"undefined"!=typeof instances[instanceId]},this.getLastInstanceId=function(){return lastRegisteredInstance},this.setCurrentPageParser=function(instanceId,val,scope){instances[instanceId].currentPageParser=val,instances[instanceId].context=scope},this.setCurrentPage=function(instanceId,val){instances[instanceId].currentPageParser.assign(instances[instanceId].context,val)},this.getCurrentPage=function(instanceId){var parser=instances[instanceId].currentPageParser;return parser?parser(instances[instanceId].context):1},this.setItemsPerPage=function(instanceId,val){instances[instanceId].itemsPerPage=val},this.getItemsPerPage=function(instanceId){return instances[instanceId].itemsPerPage},this.setCollectionLength=function(instanceId,val){instances[instanceId].collectionLength=val},this.getCollectionLength=function(instanceId){return instances[instanceId].collectionLength},this.setAsyncModeTrue=function(instanceId){instances[instanceId].asyncMode=!0},this.isAsyncMode=function(instanceId){return instances[instanceId].asyncMode}})}(),angular.module("video-ads").controller("LoginCtrl",function($scope,authService,$location,$rootScope){$rootScope.showSearchBar=!1,$rootScope.showSaveButton=!1,$scope.username="",$scope.password="",$scope.submitLogin=function(){authService.login($scope.username,$scope.password)}}),angular.module("video-ads").factory("authInterceptor",["$rootScope","$q","$window","$location","$injector","httpRequestBuffer",function($rootScope,$q,$window,$location,$injector,httpRequestBuffer){return{request:function(config){return config.headers=config.headers||{},$window.sessionStorage.token&&(config.ignoreAuthorizationHeader||(config.headers.Authorization="JWT "+$window.sessionStorage.token)),config},responseError:function(response){if(response.config&&!response.config.headers.ignoreAuthModule&&403===response.status){var deferred=$q.defer();httpRequestBuffer.append(response.config,deferred);var authService=$injector.get("authService");authService.refreshToken()}return $q.reject(response)}}}]).config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push("authInterceptor")}]).service("authService",["$window","$http","$rootScope","$location","httpRequestBuffer",function($window,$http,$rootScope,$location,httpRequestBuffer){var _login=function(username,password){return $http.post("/api-token-auth/",{username:username,password:password}).then(function(response){$window.sessionStorage.token=response.data.token,$location.path("/")})},_refreshToken=function(){return $http.post("/api-token-refresh/",{token:$window.sessionStorage.token},{ignoreAuthModule:!0}).success(function(response){$window.sessionStorage.token=response.token,httpRequestBuffer.retryAll()}).error(function(){httpRequestBuffer.rejectAll(),$location.path("/login")})};return{login:_login,refreshToken:_refreshToken}}]).factory("httpRequestBuffer",["$injector",function($injector){function _retryHttpRequest(config,deferred){function successCallback(response){deferred.resolve(response)}function errorCallback(response){deferred.reject(response)}$http=$http||$injector.get("$http"),config.headers.ignoreAuthModule=!0,$http(config).then(successCallback,errorCallback)}var $http,buffer=[];return{append:function(config,deferred){buffer.push({config:config,deferred:deferred})},rejectAll:function(reason){reason&&_.each(buffer,function(request){request.deferred.reject(reason)}),buffer=[]},retryAll:function(){_.each(buffer,function(request){_retryHttpRequest(request.config,request.deferred)}),buffer=[]}}}]),angular.module("video-ads").directive("deliveryChart",function(){return{restrict:"E",templateUrl:"shared/chart/chart.html",scope:{impressions:"@impressions"},controller:function($scope){$scope.semiCircleConfig={options:{chart:{type:"pie",backgroundColor:"transparent",height:75,margin:0,width:75},exporting:{enabled:!1},credits:{enabled:!1},tooltip:{enabled:!1},colors:["#008d52","#e2e2e2"]},series:[{dataLabels:{enabled:!1},states:{hover:{enabled:!1}},animation:!1,startAngle:-90,endAngle:90,center:["50%","75%"],innerSize:"50%",name:"Delivery",data:[parseInt($scope.impressions),100-parseInt($scope.impressions)]}],title:{text:""},subtitle:{text:""},loading:!1}}}}),angular.module("video-ads").filter("convertToLocal",function(){return function(input){return input?moment.utc(input).local().format("YYYY-MM-DD hh:mm A"):input}}),angular.module("video-ads").directive("datepicker",["$filter",function($filter){return{scope:{date:"="},replace:!0,require:"ngModel",template:'<input class="form-control" ng-model="date" type="text"/>',link:function(scope,element,attrs,ngModel){element.datetimepicker({format:"Y-m-d h:i A",startDate:new Date,step:15});var formatter=function(value){return $filter("convertToLocal")(value)};ngModel.$formatters.unshift(formatter),ngModel.$parsers.unshift(function(value){return moment(value).format("YYYY-MM-DDTHH:mm:DDZZ")})}}}]),angular.module("video-ads").directive("delivery",function(){return{templateUrl:"shared/delivery/delivery-progress.html",scope:{videoad:"="}}}),angular.module("video-ads").directive("navBar",function(){return{restrict:"E",templateUrl:"shared/navbar/navbar.html",controller:function($scope,$rootScope){$scope.searchTerm="",$scope.saveVideoAd=function(){$rootScope.$broadcast("save-video-ad")},$scope.search=function(){$rootScope.$broadcast("search",$scope.searchTerm)},$scope.clearSearch=function(){$rootScope.$broadcast("clearSearch"),$scope.searchTerm=""}}}}),angular.module("video-ads").factory("videoAdService",function(Restangular){return Restangular.setBaseUrl("/api/"),Restangular.setRequestSuffix("/"),Restangular.service("advertisements")}).config(function(RestangularProvider){RestangularProvider.addResponseInterceptor(function(data,operation){if("getList"===operation){var results=data.results;return results.meta={count:data.count,prev:data.prev,next:data.next},results}return data})}),angular.module("video-ads").filter("placeholder",function(){return function(input){return input?input:"static/images/placeholder.jpg"}});
//# sourceMappingURL=app.min.js.map